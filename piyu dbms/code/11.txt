// MongoDB Shell Commands (for Assignment 11: Map-reduce Operations)

// --- Sample Data Preparation ---
// 1. Create a database 'CityData' and collection 'city' (as per activity)
> use CityData
switched to db CityData

// 2. Insert sample documents (including the one from the manual)
// NOTE: Ensure the 'population' is stored as a number type for calculation.
> db.city.insertMany([
    { city: "pune", type: "urban", state: "MH", population: 5600000 },
    { city: "mumbai", type: "urban", state: "MH", population: 12442373 },
    { city: "nagpur", type: "metro", state: "MH", population: 2405665 },
    { city: "ahmedabad", type: "urban", state: "GJ", population: 5570585 },
    { city: "surat", type: "urban", state: "GJ", population: 4467794 },
    { city: "indore", type: "metro", state: "MP", population: 2170295 }
])

// --- Map-Reduce Functions ---

// 3. Define the MAP function: Groups data by 'state' and emits the 'population' as value.
var mapFunction = function() {
    // Emit: (key, value) -> (state, population)
    emit(this.state, this.population);
};

// 4. Define the REDUCE function: Takes the 'state' and an array of 'populations' and sums them.
var reduceFunction = function(keyState, populationValues) {
    // keyState is the state, populationValues is an array of populations for that state
    return Array.sum(populationValues);
};

// --- Map-Reduce Execution ---

// 5. Execute Map-Reduce to find statewise population
//    'out: "state_population_results"' means store the final results in a new collection.
> db.city.mapReduce(
    mapFunction,
    reduceFunction,
    { out: "state_population_results" }
)

// 6. View the final results (statewise population)
> db.state_population_results.find().pretty()